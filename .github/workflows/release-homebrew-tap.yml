name: ðŸ¦„ Update Homebrew Cask

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      ref:
        required: true
        description: "GitHub ref to use"
        type: string
      version:
        required: true
        description: "Version to produce"
        type: string
      dry-run:
        required: false
        default: true
        description: "Whether to run in dry-run mode and skip pushing the commit"
        type: boolean
  workflow_dispatch:
    inputs:
      ref:
        required: true
        description: "GitHub ref to use"
        type: string
      version:
        required: true
        description: "Version to produce"
        type: string
      dry-run:
        required: false
        default: true
        description: "Whether to run in dry-run mode and skip pushing the commit"
        type: boolean

env:
  TERRABUILD_VERSION: ${{ inputs.version }}
  GITHUB_TOKEN: ${{ secrets.GIT_PAT }}

jobs:
  update-homebrew-cask:
    name: Update Homebrew Cask
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          path: terrabuild
      - name: Checkout cask repo
        uses: actions/checkout@v4
        with:
          repository: magnusopera/homebrew-cask
          path: homebrew-cask
          token: ${{ secrets.GIT_PAT }}
      - name: Update Homebrew Cask
        run: |
          set -euo pipefail

          # Can simulate this by cloning magnusopera/terrabuild & magnusopera/homebrew-cask to adacent directories
          # and running from their parent:

          ./terrabuild/.github/scripts/generate-homebrew-cask \
            "${TERRABUILD_VERSION}" ./terrabuild/.github/scripts/terrabuild-cask-template.rb \
            > ./homebrew-cask/Casks/terrabuild.rb
      - name: Commit Updated Cask
        working-directory: homebrew-cask
        run: |
          set -euo pipefail

          git config user.name magnusopera-bot
          git config user.email bot@magnusopera.io
          git add Casks/terrabuild.rb
          echo "::group::git diff"
          git  --no-pager diff
          echo "::endgroup::"
          git commit -m "Brew Cask update for Terrabuild version ${TERRABUILD_VERSION}"
      - name: Push Cask
        working-directory: homebrew-cask
        if: ${{ !inputs.dry-run }}
        run: |
          set -euo pipefail

          git push origin HEAD:main
